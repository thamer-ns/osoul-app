# Ø§Ø³ØªØ¨Ø¯Ù„ Ø¯Ø§Ù„Ø© view_portfolio Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
def view_portfolio(fin, page_key):
    ts = "Ù…Ø¶Ø§Ø±Ø¨Ø©" if page_key == 'spec' else "Ø§Ø³ØªØ«Ù…Ø§Ø±"
    st.header(f"ğŸ’¼ Ù…Ø­ÙØ¸Ø© {ts}")
    all_d = fin['all_trades']
    df = pd.DataFrame()
    if not all_d.empty:
        df = all_d[all_d['strategy'].astype(str).str.contains(ts, na=False)].copy()
    
    # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    if not df.empty:
        total_market = df[df['status']=='Open']['market_value'].sum()
        df['weight'] = df.apply(lambda x: (x['market_value'] / total_market * 100) if x['status']=='Open' and total_market > 0 else 0, axis=1)
        df['daily_change'] = df.apply(lambda x: ((x['current_price'] - x['prev_close']) / x['prev_close'] * 100) if pd.notna(x['prev_close']) and x['prev_close'] > 0 else 0, axis=1)

    COLS_FULL = [
        ('company_name', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©'), ('sector', 'Ø§Ù„Ù‚Ø·Ø§Ø¹'), ('status', 'Ø§Ù„Ø­Ø§Ù„Ø©'),
        ('symbol', 'Ø±Ù…Ø² Ø§Ù„Ø´Ø±ÙƒØ©'), ('date', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡'), ('exit_date', 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹'),
        ('quantity', 'Ø§Ù„ÙƒÙ…ÙŠØ©'), ('entry_price', 'Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡'), ('total_cost', 'Ø§Ù„ØªÙƒÙ„ÙØ©'),
        ('year_high', 'Ø§Ø¹Ù„Ù‰ Ø³Ù†ÙˆÙŠ'), ('current_price', 'Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ'), ('year_low', 'Ø§Ø¯Ù†Ù‰ Ø³Ù†ÙˆÙŠ'),
        ('market_value', 'Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚'), ('gain', 'Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©'), ('gain_pct', 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø©'),
        ('weight', 'ÙˆØ²Ù† Ø§Ù„Ø³Ù‡Ù…'), ('daily_change', 'Ù†Ø³Ø¨Ø© Ø§Ù„ØªØºÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ'), ('prev_close', 'Ø§ØºÙ„Ø§Ù‚ Ø§Ù„Ø§Ù…Ø³')
    ]

    # Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
    if not df.empty:
        op = df[df['status']=='Open'].copy()
        market_val = op['quantity'].mul(op['current_price']).sum() if not op.empty else 0
        total_cost = op['quantity'].mul(op['entry_price']).sum() if not op.empty else 0
        unrealized = market_val - total_cost
        cl = df[df['status']=='Close'].copy()
        realized_profit = ((cl['exit_price'] - cl['entry_price']) * cl['quantity']).sum() if not cl.empty else 0

        c1, c2, c3, c4 = st.columns(4)
        with c1: render_kpi("Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©", safe_fmt(market_val), "blue")
        with c2: render_kpi("Ø§Ù„ØªÙƒÙ„ÙØ©", safe_fmt(total_cost))
        with c3: render_kpi("Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¹Ø§Ø¦Ù…", safe_fmt(unrealized), unrealized)
        with c4: render_kpi("Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚", safe_fmt(realized_profit), realized_profit)
        st.markdown("---")

    if df.empty: st.info("Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙØ§Ø±ØºØ©"); return

    open_df = df[df['status']=='Open'].copy()
    closed_df = df[df['status']=='Close'].copy()

    t1, t2, t3 = st.tabs(["Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©", "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø´ÙŠÙ"])
    
    # --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ© (ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø¨ÙŠØ¹) ---
    with t1:
        if not open_df.empty:
            # ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙ‚Ø·
            open_df = open_df.sort_values(by="date", ascending=False)
            render_table(open_df, COLS_FULL)
        else: st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù‡Ù… Ø­Ø§Ù„ÙŠØ©")
    
    # --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªØ­Ù„ÙŠÙ„ ---
    with t2:
        if not open_df.empty and page_key == 'invest':
            fig = px.pie(open_df, values='market_value', names='sector', hole=0.4)
            st.plotly_chart(fig, use_container_width=True)
            
    # --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø£Ø±Ø´ÙŠÙ ---
    with t3:
        if not closed_df.empty: 
            closed_df['net_sales'] = closed_df['quantity'] * closed_df['exit_price']
            closed_df['realized_gain'] = closed_df['net_sales'] - closed_df['total_cost']
            c1, c2 = st.columns(2)
            with c1: render_kpi("ØµØ§ÙÙŠ Ø§Ù„Ø¨ÙŠØ¹", safe_fmt(closed_df['net_sales'].sum()), "blue")
            with c2: render_kpi("Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø­Ù‚Ù‚", safe_fmt(closed_df['realized_gain'].sum()))
            render_table(closed_df, COLS_FULL)
        else: st.info("Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº")
